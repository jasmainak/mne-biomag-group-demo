<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>06. Construct epochs &#8212; MNE Biomag Demo</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.3.6/flatly/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          MNE Biomag Demo</a>
        <span class="navbar-text navbar-version pull-left"><b>1.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../auto_examples/index.html">Results</a></li>
                <li><a href="index.html">Processing Scripts</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">06. Construct epochs</a></li>
</ul>
</ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="construct-epochs">
<span id="sphx-glr-auto-scripts-06-make-epochs-py"></span><h1>06. Construct epochs<a class="headerlink" href="#construct-epochs" title="Permalink to this headline">Â¶</a></h1>
<p>The epochs are constructed by using the events created in script 03. MNE
supports hierarchical events that allows selection to different groups more
easily. Some channels were not properly defined during acquisition, so they
are redefined before epoching. Bad EEG channels are interpolated and epochs
containing blinks are rejected. ECG artifacts are corrected using ICA. Finally
the epochs are saved to disk. To save space, the epoch data is decimated by
a factor of 5 (from a sample rate of 1100 Hz to 220 Hz).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="kn">as</span> <span class="nn">op</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">mne</span>
<span class="kn">from</span> <span class="nn">mne.parallel</span> <span class="kn">import</span> <span class="n">parallel_func</span>
<span class="kn">from</span> <span class="nn">mne.preprocessing</span> <span class="kn">import</span> <a href="https://mne-tools.github.io/dev/generated/mne.preprocessing.create_ecg_epochs.html#mne.preprocessing.create_ecg_epochs" title="View documentation for mne.preprocessing.create_ecg_epochs"><span class="n">create_ecg_epochs</span></a><span class="p">,</span> <a href="https://mne-tools.github.io/dev/generated/mne.preprocessing.create_eog_epochs.html#mne.preprocessing.create_eog_epochs" title="View documentation for mne.preprocessing.create_eog_epochs"><span class="n">create_eog_epochs</span></a><span class="p">,</span> <a href="https://mne-tools.github.io/dev/generated/mne.preprocessing.read_ica.html#mne.preprocessing.read_ica" title="View documentation for mne.preprocessing.read_ica"><span class="n">read_ica</span></a>

<span class="kn">from</span> <span class="nn">autoreject</span> <span class="kn">import</span> <span class="n">get_rejection_threshold</span>

<span class="kn">from</span> <span class="nn">library.config</span> <span class="kn">import</span> <span class="p">(</span><span class="n">meg_dir</span><span class="p">,</span> <span class="n">map_subjects</span><span class="p">,</span> <span class="n">l_freq</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span>
                            <span class="n">reject_tmax</span><span class="p">)</span>
</pre></div>
</div>
<p>We define the events and the onset and offset of the epochs</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">events_id</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;face/famous/first&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">&#39;face/famous/immediate&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="s1">&#39;face/famous/long&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s1">&#39;face/unfamiliar/first&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
    <span class="s1">&#39;face/unfamiliar/immediate&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
    <span class="s1">&#39;face/unfamiliar/long&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
    <span class="s1">&#39;scrambled/first&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span>
    <span class="s1">&#39;scrambled/immediate&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
    <span class="s1">&#39;scrambled/long&#39;</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">baseline</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">l_freq</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
</pre></div>
</div>
<p>Now we define a function to extract epochs for one subject</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_epochs</span><span class="p">(</span><span class="n">subject_id</span><span class="p">,</span> <span class="n">tsss</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;sub</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">subject_id</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Processing subject: </span><span class="si">%s%s</span><span class="s2">&quot;</span>
          <span class="o">%</span> <span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39; (tSSS=</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">tsss</span><span class="p">)</span> <span class="k">if</span> <span class="n">tsss</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

    <span class="n">data_path</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meg_dir</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>

    <span class="c1"># map to correct subject for bad channels</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">map_subjects</span><span class="p">[</span><span class="n">subject_id</span><span class="p">]</span>

    <span class="n">raw_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">events_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;  Loading raw data&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
        <span class="n">bads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">bad_name</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;bads&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="s1">&#39;run_</span><span class="si">%02d</span><span class="s1">_raw_tr.fif_bad&#39;</span> <span class="o">%</span> <span class="n">run</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bad_name</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bad_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">bads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">tsss</span><span class="p">:</span>
            <span class="n">run_fname</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;run_</span><span class="si">%02d</span><span class="s1">_filt_tsss_</span><span class="si">%d</span><span class="s1">_raw.fif&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">tsss</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run_fname</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;run_</span><span class="si">%02d</span><span class="s1">_filt_sss_&#39;</span>
                                <span class="s1">&#39;highpass-</span><span class="si">%s</span><span class="s1">Hz_raw.fif&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">l_freq</span><span class="p">))</span>

        <span class="n">raw</span> <span class="o">=</span> <a href="https://mne-tools.github.io/dev/generated/mne.io.read_raw_fif.html#mne.io.read_raw_fif" title="View documentation for mne.io.read_raw_fif"><span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_raw_fif</span></a><span class="p">(</span><span class="n">run_fname</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">delay</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">0.0345</span> <span class="o">*</span> <span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;sfreq&#39;</span><span class="p">]))</span>
        <span class="n">events</span> <span class="o">=</span> <a href="https://mne-tools.github.io/dev/generated/mne.read_events.html#mne.read_events" title="View documentation for mne.read_events"><span class="n">mne</span><span class="o">.</span><span class="n">read_events</span></a><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;run_</span><span class="si">%02d</span><span class="s1">-eve.fif&#39;</span> <span class="o">%</span> <span class="n">run</span><span class="p">))</span>
        <span class="n">events</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">events</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">delay</span>
        <span class="n">events_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

        <span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;bads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bads</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">interpolate_bads</span><span class="p">()</span>
        <span class="n">raw_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

    <span class="n">raw</span><span class="p">,</span> <span class="n">events</span> <span class="o">=</span> <a href="https://mne-tools.github.io/dev/generated/mne.concatenate_raws.html#mne.concatenate_raws" title="View documentation for mne.concatenate_raws"><span class="n">mne</span><span class="o">.</span><span class="n">concatenate_raws</span></a><span class="p">(</span><span class="n">raw_list</span><span class="p">,</span> <span class="n">events_list</span><span class="o">=</span><span class="n">events_list</span><span class="p">)</span>
    <span class="n">raw</span><span class="o">.</span><span class="n">set_eeg_reference</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">raw_list</span>

    <span class="n">picks</span> <span class="o">=</span> <a href="https://mne-tools.github.io/dev/generated/mne.pick_types.html#mne.pick_types" title="View documentation for mne.pick_types"><span class="n">mne</span><span class="o">.</span><span class="n">pick_types</span></a><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">meg</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eeg</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                           <span class="n">eog</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">())</span>

    <span class="c1"># Epoch the data</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;  Epoching&#39;</span><span class="p">)</span>
    <span class="n">epochs</span> <span class="o">=</span> <a href="https://mne-tools.github.io/dev/generated/mne.Epochs.html#mne.Epochs" title="View documentation for mne.Epochs"><span class="n">mne</span><span class="o">.</span><span class="n">Epochs</span></a><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">events_id</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                        <span class="n">picks</span><span class="o">=</span><span class="n">picks</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">decim</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">reject</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reject_tmax</span><span class="o">=</span><span class="n">reject_tmax</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;  Interpolating bad channels&#39;</span><span class="p">)</span>

    <span class="c1"># ICA</span>
    <span class="k">if</span> <span class="n">tsss</span><span class="p">:</span>
        <span class="n">ica_name</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meg_dir</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s1">&#39;run_concat-tsss_</span><span class="si">%d</span><span class="s1">-ica.fif&#39;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="n">tsss</span><span class="p">,))</span>
        <span class="n">ica_out_name</span> <span class="o">=</span> <span class="n">ica_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ica_name</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meg_dir</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s1">&#39;run_concat-ica.fif&#39;</span><span class="p">)</span>
        <span class="n">ica_out_name</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meg_dir</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span>
                               <span class="s1">&#39;run_concat_highpass-</span><span class="si">%s</span><span class="s1">Hz-ica.fif&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">l_freq</span><span class="p">,))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;  Using ICA&#39;</span><span class="p">)</span>
    <span class="n">ica</span> <span class="o">=</span> <a href="https://mne-tools.github.io/dev/generated/mne.preprocessing.read_ica.html#mne.preprocessing.read_ica" title="View documentation for mne.preprocessing.read_ica"><span class="n">read_ica</span></a><span class="p">(</span><span class="n">ica_name</span><span class="p">)</span>
    <span class="n">ica</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">filter_label</span> <span class="o">=</span> <span class="s1">&#39;-tsss_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tsss</span> <span class="k">if</span> <span class="n">tsss</span> <span class="k">else</span> <span class="s1">&#39;_highpass-</span><span class="si">%s</span><span class="s1">Hz&#39;</span> <span class="o">%</span> <span class="n">l_freq</span>
    <span class="n">ecg_epochs</span> <span class="o">=</span> <a href="https://mne-tools.github.io/dev/generated/mne.preprocessing.create_ecg_epochs.html#mne.preprocessing.create_ecg_epochs" title="View documentation for mne.preprocessing.create_ecg_epochs"><span class="n">create_ecg_epochs</span></a><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=-.</span><span class="mi">3</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">eog_epochs</span> <span class="o">=</span> <a href="https://mne-tools.github.io/dev/generated/mne.preprocessing.create_eog_epochs.html#mne.preprocessing.create_eog_epochs" title="View documentation for mne.preprocessing.create_eog_epochs"><span class="n">create_eog_epochs</span></a><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=-.</span><span class="mi">5</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">raw</span>

    <span class="n">n_max_ecg</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># use max 3 components</span>
    <span class="n">ecg_epochs</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">ecg_epochs</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
    <span class="n">ecg_epochs</span><span class="o">.</span><span class="n">apply_baseline</span><span class="p">((</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
    <span class="n">ecg_inds</span><span class="p">,</span> <span class="n">scores_ecg</span> <span class="o">=</span> <span class="n">ica</span><span class="o">.</span><span class="n">find_bads_ecg</span><span class="p">(</span><span class="n">ecg_epochs</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ctps&#39;</span><span class="p">,</span>
                                             <span class="n">threshold</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;    Found </span><span class="si">%d</span><span class="s1"> ECG indices&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ecg_inds</span><span class="p">),))</span>
    <span class="n">ica</span><span class="o">.</span><span class="n">exclude</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ecg_inds</span><span class="p">[:</span><span class="n">n_max_ecg</span><span class="p">])</span>
    <span class="n">ecg_epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">-ecg-ave.fif&#39;</span>
                                      <span class="o">%</span> <span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">filter_label</span><span class="p">)))</span>
    <a href="https://docs.scipy.org/doc/numpy-dev/reference/generated/numpy.save.html#numpy.save" title="View documentation for numpy.save"><span class="n">np</span><span class="o">.</span><span class="n">save</span></a><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">-ecg-scores.npy&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">filter_label</span><span class="p">)),</span> <span class="n">scores_ecg</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">ecg_epochs</span>

    <span class="n">n_max_eog</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># use max 2 components</span>
    <span class="n">eog_epochs</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">eog_epochs</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
    <span class="n">eog_epochs</span><span class="o">.</span><span class="n">apply_baseline</span><span class="p">((</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
    <span class="n">eog_inds</span><span class="p">,</span> <span class="n">scores_eog</span> <span class="o">=</span> <span class="n">ica</span><span class="o">.</span><span class="n">find_bads_eog</span><span class="p">(</span><span class="n">eog_epochs</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;    Found </span><span class="si">%d</span><span class="s1"> EOG indices&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eog_inds</span><span class="p">),))</span>
    <span class="n">ica</span><span class="o">.</span><span class="n">exclude</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">eog_inds</span><span class="p">[:</span><span class="n">n_max_eog</span><span class="p">])</span>
    <span class="n">eog_epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">-eog-ave.fif&#39;</span>
                                      <span class="o">%</span> <span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">filter_label</span><span class="p">)))</span>
    <a href="https://docs.scipy.org/doc/numpy-dev/reference/generated/numpy.save.html#numpy.save" title="View documentation for numpy.save"><span class="n">np</span><span class="o">.</span><span class="n">save</span></a><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">-eog-scores.npy&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">filter_label</span><span class="p">)),</span> <span class="n">scores_eog</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">eog_epochs</span>

    <span class="n">ica</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">ica_out_name</span><span class="p">)</span>
    <span class="n">epochs</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
    <span class="n">ica</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;  Getting rejection thresholds&#39;</span><span class="p">)</span>
    <span class="n">reject</span> <span class="o">=</span> <span class="n">get_rejection_threshold</span><span class="p">(</span><span class="n">epochs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">reject_tmax</span><span class="p">))</span>
    <span class="n">epochs</span><span class="o">.</span><span class="n">drop_bad</span><span class="p">(</span><span class="n">reject</span><span class="o">=</span><span class="n">reject</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;  Dropped </span><span class="si">%0.1f%%</span><span class="s1"> of epochs&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epochs</span><span class="o">.</span><span class="n">drop_log_stats</span><span class="p">(),))</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;  Writing to disk&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tsss</span><span class="p">:</span>
        <span class="n">epochs</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-tsss_</span><span class="si">%d</span><span class="s1">-epo.fif&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">tsss</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">epochs</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_highpass-</span><span class="si">%s</span><span class="s1">Hz-epo.fif&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">l_freq</span><span class="p">)))</span>
</pre></div>
</div>
<p>Let us make the script parallel across subjects</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Here we use n_jobs=1 to prevent potential memory problems</span>
<span class="n">parallel</span><span class="p">,</span> <span class="n">run_func</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parallel_func</span><span class="p">(</span><span class="n">run_epochs</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">parallel</span><span class="p">(</span><span class="n">run_func</span><span class="p">(</span><span class="n">subject_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">subject_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="k">if</span> <span class="n">l_freq</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">parallel</span><span class="p">(</span><span class="n">run_func</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">tsss</span><span class="p">)</span> <span class="k">for</span> <span class="n">tsss</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># Maxwell filtered data</span>
</pre></div>
</div>
<p><strong>Total running time of the script:</strong> ( 0 minutes  0.000 seconds)</p>
<div class="sphx-glr-footer container">
<div class="sphx-glr-download container">
<a class="reference download internal" href="../_downloads/06-make_epochs.py" download=""><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">06-make_epochs.py</span></code></a></div>
<div class="sphx-glr-download container">
<a class="reference download internal" href="../_downloads/06-make_epochs.ipynb" download=""><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">06-make_epochs.ipynb</span></code></a></div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.readthedocs.io">Gallery generated by Sphinx-Gallery</a></p>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, MNE Developers. Last updated on 2017-11-09.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>